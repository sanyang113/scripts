var status = -1;
var sel = -1;

var items = [
    2210000, 2210001, 2210002, 2210003, 2210004, 2210005, 2210006, 2210007, 2210009, 2210012, 2210015, 2210016, 2210017, 2210018, 2210019, 2210020, 2210021, 
    2210022, 2210025, 2210026, 2210027, 2210028, 2210029, 2210030, 2210031, 2210034, 2210035, 2210036, 2210037, 2210038, 2210039, 2210040, 2210041, 2210042, 2210044, 2210045, 2210046, 2210047, 
    2210061, 2210065, 2210066, 2210067, 2210068, 2210069, 2210070, 2210081, 2210082, 2210084, 2210085, 2210086, 2210091, 2210103, 2210104, 2210105, 2210106, 2210107, 2210108, 2210109, 2210110, 
    2210111, 2210112, 2210113, 2210114, 2210115, 2210118, 2210120, 2210121, 2210122, 2210123, 2210124, 2210125, 2210126, 2210127, 2210128, 2210129, 2210131, 2210132, 2210133, 2210135, 2210136, 
    2210138, 2210139, 2210140, 2210141, 2210164, 2210165, 2210166, 2210167, 2210168, 2210169, 2210170, 2210171, 2210172, 2210175, 2210176, 2210177, 2210178, 2210179, 2210181, 2210182, 2210183, 
    2210184, 2210185, 2210186, 2210191, 2210192, 2210193, 2210194, 2210195, 2210196, 2210197, 2210199, 2210200, 2210202, 2210203, 2210204, 2210205, 2210207, 2210208, 2210209, 2210210, 2210211, 
    2210217, 2210218, 2210219, 2210220, 2210221, 2210222, 2210257, 2210258, 2210259, 2210262, 2210263, 2210264, 2210265, 2210266, 2210267, 2210268, 2210269, 2210270, 2210271, 2210272, 2210273, 
    2210274, 2213000, 2213001, 2213002, 2213003, 2213004, 2213005, 2213006, 2213007, 2213008, 2213009, 2213010, 2213011, 2213012, 2213013, 2213014, 2213015, 2213016, 2213017, 2213018, 2213019, 
    2213020, 2213021, 2213022, 2213023, 2213024, 2213025, 2213026, 2213027, 2213028, 2213029, 2213030, 2213031, 2213032, 2213033, 2213034, 2213035, 2213036, 2213037, 2213038, 2213039, 2213040, 
    2213041, 2213043, 2213070, 2213071, 2213072
]

function start() {
    return action(1,0,0);
}

function action(mode, type, selection) {
    if (mode == 1) {
        status++;
    } else if (mode == 0) {
        cm.dispose();
        return;
    } else {
        cm.dispose();
        return;
    }

    switch(status) {
        case 0:
            var msg = "您是否要將地圖上的玩家進行集體變身？\r\n\r\n";
            msg += "#L1##b指定變身\r\n";
            msg += "#L2##b隨機變身\r\n";
            cm.sendNext(msg);
            break;
        case 1:
            sel = selection;
            if(sel == 1) {
                var msg = "請選擇變身項目\r\n\r\n";
                for(var i = 0; i < items.length; i++) {
                msg += "#L" + i + "##b#i" + items[i] + ":##t" + items[i] + "##k" + items[i]  +  "\r\n";
                }
                cm.sendNext(msg);
                break;
            } else if(sel == 2) {
                var msg = "確定要進行集體變身嗎？";
                cm.sendYesNo(msg);
                break;
            }
        case 2:
            var players = cm.getPlayer().getMap().getCharactersThreadsafe();
            if(sel == 1) {
                for(var i = 0; i < players.length; i++) {
                    var player = players[i];
                    player.applyMorphBuff(items[selection], true);
                }
                cm.sendOk("變身完畢");
                cm.dispose();
                return;
            } else if(sel == 2) {
                for(var i = 0; i < players.length; i++) {
                    var random = Math.floor(Math.random() * items.length);
                    var player = players[i];
                    player.applyMorphBuff(items[random], true);
                }
                cm.sendOk("變身完畢");
                cm.dispose();
                return;
            }
        default:
            cm.dispose();
            return;
    }
}
